---
title: "FSE Dashboard"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    orientation: columns
    vertical_layout: fill
    includes:
      in_header: google-analytics.html
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(fse)
  library(flexdashboard)
  library(dplyr)
  library(leaflet)
})
```





# FBOs for sale

```{r fbosale-data-test, eval=FALSE}
fbos <- data.frame(
  lon=c(50, -50) , 
  lat=c(-50, 50),
  label = letters[1:2],
  stringsAsFactors = FALSE
)
```

```{r fbosale-data-fetch, eval=!file.exists("fbos.rds")}
fse::fse_fbo_for_sale() %>%
  saveRDS(file="fbos.rds")
```

```{r fbosale-data-load}
readRDS("fbos.rds") %>%
  left_join(icao_data, by=c("Icao"="icao")) %>%
  as_tibble() %>%
  mutate(
    popup = paste(
      Icao, 
      Airport, 
      paste0("Lots: ", Lots), 
      paste0("Gates: ", Gates), 
      paste0("Price: ", format(SellPrice, scientific = FALSE)),
      sep = "<br/>"
    )
  ) -> fbos
```


```{r fbosale-map}
fbos %>%
  leaflet() %>%
  addTiles() %>%
  addMarkers(
    lng = ~lon, 
    lat = ~lat, 
    popup = ~popup
  )
```









# All-In Q400 (Table)

```{r allin-q400-fetch, eval=!file.exists("allin-q400.rds")}
fse_aircraft_by_makemodel("Bombardier Dash-8 Q400") %>%
  filter(Location != "In Flight") -> q400
fse_icao_jobs_from(unique(q400$Location)) %>%
  inner_join(q400, by=c("AircraftId"="SerialNumber")) %>%
  saveRDS("allin-q400.rds")
```

```{r allin-q400-load}
readRDS("allin-q400.rds") -> q400
```

```{r allin-q400-table}
q400 %>%
  transmute(
    Pay,
    From = fse_link_icao(FromIcao) %>% to_html(), 
    To = fse_link_icao(ToIcao) %>% to_html(), 
    What = paste(Amount, Commodity),
    Expires
  ) %>%
  arrange(desc(Pay)) %>%
  DT::datatable(escape = FALSE)
```


# All-In Q400 (Map)

```{r allin-q400-map}
q400 %>%
  left_join(
    icao_data %>%
      select(
        FromIcao = icao,
        from_lon = lon,
        from_lat = lat
      ),
    by = "FromIcao"
  ) %>%
  left_join(
    icao_data %>%
      select(
        ToIcao = icao,
        to_lon = lon,
        to_lat = lat
      ),
    by = "ToIcao"
  ) %>%
  mutate(
    label = paste0(
      FromIcao, "-", ToIcao,
      ", ",
      "v$", Pay
    )
  ) -> z

z %>%
  with(
    geosphere::gcIntermediate(
      cbind(from_lon, from_lat), cbind(to_lon, to_lat),
      n = 5,
      addStartEnd = TRUE,
      sp = TRUE
    )
  ) -> pths

pths %>%
  leaflet() %>%
  addTiles() %>%
  addPolylines(label=z$label)
```










# About

FSE data is fetched roughly once every 24 hours. Last fetch on **`r format(fetched_at <- Sys.time(), tz='UTC')`** UTC.

The dashboard is implemented using R and [`fse`](https://github.com/rfse/fse) package.

I am `skybike`. Find me on FSE Discord server.
